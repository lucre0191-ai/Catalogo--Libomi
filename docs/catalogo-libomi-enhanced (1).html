<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cat√°logo Libomi ‚Äî Gesti√≥n</title>
<style>
  /* ---------- Reset / base ---------- */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    margin:0; background:#f4f6f8; color:#222; -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex; flex-direction:column; align-items:center;
  }

  /* ---------- Header ---------- */
  header{
    width:100%; background:linear-gradient(90deg,#1e88e5,#06b6d4);
    color:#fff; position:sticky; top:0; z-index:1200; box-shadow:0 6px 18px rgba(0,0,0,.12)
  }
  .header-inner{max-width:1200px; margin:0 auto; padding:14px 18px; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  #logo{height:56px; width:auto; border-radius:10px; background:rgba(255,255,255,0.12); padding:6px}
  .title {font-size:20px; font-weight:700; margin-left:8px; flex:1; text-align:center}
  .logo-controls{display:flex; gap:8px; align-items:center}

  /* ---------- Tabs ---------- */
  .tabs{max-width:1200px; width:100%; display:flex; gap:8px; padding:12px 18px; margin-bottom:8px}
  .tab{padding:10px 16px; border-radius:999px; border:2px solid rgba(255,255,255,0.18); background:transparent; color:#fff; cursor:pointer; font-weight:700}
  .tab.active{background:#fff; color:#0f172a; box-shadow:0 8px 24px rgba(0,0,0,.08)}

  /* ---------- Layout ---------- */
  .container{width:100%; max-width:1200px; padding:18px}
  .toolbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:14px}

  .btn{appearance:none; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; transition:transform .12s, box-shadow .12s}
  .btn:active{transform:translateY(1px)}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .btn.primary{background:#0ea5e9; color:#fff}
  .btn.ghost{background:#fff; color:#0f172a; border:1px solid #e6eef5}
  .btn.warn{background:#f59e0b; color:#111}
  .btn.danger{background:#ef4444; color:#fff}

  /* ---------- Forms ---------- */
  .card{background:#fff; border-radius:14px; box-shadow:0 12px 30px rgba(16,24,40,.06); padding:16px}
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .form-row{display:flex; gap:12px; flex-wrap:wrap}
  label{font-weight:700; font-size:13px; color:#374151; margin-bottom:6px; display:block}
  input[type="text"], input[type="search"], select, textarea, input[type="file"]{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6eef5; background:#fff; font:inherit;
  }
  textarea{min-height:90px; resize:vertical}

  /* ---------- Image preview ---------- */
  .img-preview{width:150px; height:150px; border-radius:10px; overflow:hidden; border:1px solid #e6eef5; display:flex; align-items:center; justify-content:center; background:#fafafa}
  .img-preview img{width:100%; height:100%; object-fit:cover}

  /* ---------- Product cards with enhanced image interactions ---------- */
  .grid{display:flex; flex-wrap:wrap; gap:18px}
  .product-card{width:340px; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 12px 28px rgba(2,6,23,.06); display:flex; flex-direction:column}
  .product-top{display:flex; gap:12px; padding:12px}
  .thumb{
    width:120px; height:120px; border-radius:8px; overflow:hidden; background:#f3f4f6; border:1px solid #eef2f6;
    position:relative; cursor:pointer;
  }
  .thumb img{
    width:100%; height:100%; object-fit:cover;
    transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  /* Zoom hover effect */
  .thumb:hover img{
    transform:scale(1.1);
  }
  /* Zoom hint overlay */
  .thumb::after{
    content:'üîç Click para ampliar';
    position:absolute; bottom:0; left:0; right:0;
    background:linear-gradient(transparent, rgba(0,0,0,0.8));
    color:#fff; font-size:10px; text-align:center; padding:8px 4px;
    opacity:0; transition:opacity .3s;
  }
  .thumb:hover::after{
    opacity:1;
  }

  .product-info{flex:1}
  .product-info h4{margin:0 0 4px}
  .muted{color:#64748b; font-size:13px}

  .product-actions{display:flex; gap:8px; padding:10px; border-top:1px solid #f1f5f9; justify-content:flex-end}

  /* ---------- Enhanced Lightbox Modal ---------- */
  .lightbox{
    position:fixed; top:0; left:0; width:100vw; height:100vh;
    background:rgba(0,0,0,0.95); z-index:9999;
    display:none; align-items:center; justify-content:center;
    cursor:zoom-out;
  }
  .lightbox.active{display:flex}
  
  .lightbox-content{
    position:relative; max-width:95vw; max-height:95vh;
    display:flex; align-items:center; justify-content:center;
  }
  
  .lightbox-image{
    max-width:100%; max-height:100%; object-fit:contain;
    border-radius:8px; box-shadow:0 20px 40px rgba(0,0,0,0.5);
    transition:transform .3s ease;
    cursor:grab;
  }
  
  .lightbox-image:active{cursor:grabbing}
  
  /* Close button */
  .lightbox-close{
    position:absolute; top:20px; right:20px;
    background:rgba(255,255,255,0.2); border:none; border-radius:50%;
    width:50px; height:50px; color:#fff; font-size:24px; font-weight:bold;
    cursor:pointer; backdrop-filter:blur(10px);
    transition:background .3s, transform .2s;
  }
  .lightbox-close:hover{
    background:rgba(255,255,255,0.3); transform:scale(1.1);
  }

  /* Info overlay */
  .lightbox-info{
    position:absolute; bottom:0; left:0; right:0;
    background:linear-gradient(transparent, rgba(0,0,0,0.8));
    color:#fff; padding:20px; text-align:center;
    transform:translateY(100%); transition:transform .3s;
  }
  .lightbox.show-info .lightbox-info{transform:translateY(0)}
  
  /* Zoom controls */
  .zoom-controls{
    position:absolute; bottom:20px; right:20px;
    display:flex; gap:8px; flex-direction:column;
  }
  .zoom-btn{
    background:rgba(255,255,255,0.2); border:none; border-radius:50%;
    width:40px; height:40px; color:#fff; font-size:18px; font-weight:bold;
    cursor:pointer; backdrop-filter:blur(10px);
    transition:background .3s, transform .2s;
  }
  .zoom-btn:hover{
    background:rgba(255,255,255,0.3); transform:scale(1.1);
  }

  /* Category lists ---------- */
  .list{padding:8px; background:#fff; border-radius:10px; border:1px solid #edf2f7; max-height:320px; overflow:auto}
  .list-item{display:flex; justify-content:space-between; padding:8px; align-items:center; border-bottom:1px dashed #f1f5f9}
  .list-item:last-child{border-bottom:none}

  /* ---------- Import/Export ---------- */
  textarea.code{min-height:140px; font-family:monospace; white-space:pre-wrap}

  /* ---------- Toast ---------- */
  .toast{position:fixed; right:18px; top:18px; padding:12px 16px; border-radius:10px; color:#fff; font-weight:800; z-index:9999; opacity:0; transform:translateY(-10px); transition:all .22s}
  .toast.show{opacity:1; transform:translateY(0)}
  .toast.ok{background:#16a34a} .toast.warn{background:#f59e0b; color:#111} .toast.err{background:#ef4444}

  /* ---------- URL Display ---------- */
  .url-info {
    background: rgba(255,255,255,0.15);
    color: #fff;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-family: monospace;
    word-break: break-all;
    margin-left: auto;
  }

  /* ---------- Print styles ---------- */
  @media print{
    body{background:#fff; color:#000}
    header, .tabs, .toolbar, .btn, input, textarea, .toast, .url-info, .lightbox { display: none !important; }
    .container{max-width:100%; padding:0; margin:0}
    .product-card{page-break-inside:avoid; break-inside:avoid; box-shadow:none; border:1px solid #ccc}
    .grid{display:flex; flex-wrap:wrap; gap:10px}
    .product-card{width:45%; margin:6px}
    .thumb::after{display:none}
    @page { margin: 12mm; }
  }

  /* Responsive */
  @media (max-width:900px){
    .form-grid{grid-template-columns:1fr}
    .product-card{width:100%}
    .url-info { display: none; }
    .lightbox-close{top:10px; right:10px; width:40px; height:40px; font-size:20px}
    .zoom-controls{bottom:10px; right:10px}
    .zoom-btn{width:35px; height:35px; font-size:16px}
  }
</style>
</head>
<body>
  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox">
    <button class="lightbox-close" id="lightboxClose">&times;</button>
    <div class="lightbox-content">
      <img id="lightboxImage" class="lightbox-image" alt="Imagen ampliada">
      <div class="lightbox-info" id="lightboxInfo">
        <h3 id="lightboxTitle">Nombre del producto</h3>
        <p id="lightboxDescription">Descripci√≥n del producto</p>
      </div>
    </div>
    <div class="zoom-controls">
      <button class="zoom-btn" id="zoomIn">+</button>
      <button class="zoom-btn" id="zoomOut">‚àí</button>
      <button class="zoom-btn" id="zoomReset">‚åÇ</button>
    </div>
  </div>

  <header>
    <div class="header-inner">
      <img id="logo" alt="Logo">
      <div class="title">Cat√°logo de Productos ‚Äî Libomi</div>
      <div class="url-info" id="urlDisplay">
        üì° Accesible desde: <span id="currentUrl"></span>
      </div>
      <div class="logo-controls">
        <input id="logoFile" type="file" accept="image/*" style="display:none">
        <button class="btn ghost" id="changeLogoBtn">Cambiar logo</button>
        <button class="btn ghost" id="clearLogoBtn">Quitar logo</button>
      </div>
    </div>

    <div class="tabs" role="tablist">
      <button class="tab active" data-tab="editor">Entrada de datos</button>
      <button class="tab" data-tab="catalogo">Ver cat√°logo</button>
      <button class="tab" data-tab="categorias">Categor√≠as</button>
      <button class="tab" data-tab="respaldo">Importar / Exportar</button>
    </div>
  </header>

  <main class="container">
    <!-- EDITOR -->
    <section id="editorView" class="view active">
      <div class="card">
        <h3 style="margin-top:0">Agregar / Editar producto</h3>
        <div id="productForm">
          <input type="hidden" id="productId">
          <div class="form-grid">
            <div>
              <label for="name">Nombre *</label>
              <input id="name" type="text" required placeholder="Nombre del producto">

              <label for="code" style="margin-top:8px">C√≥digo</label>
              <input id="code" type="text" placeholder="C√≥digo de inventario">

              <label for="category" style="margin-top:8px">Categor√≠a *</label>
              <select id="category" required></select>

              <label for="subcategory" style="margin-top:8px">Subcategor√≠a</label>
              <select id="subcategory"></select>

              <label for="description" style="margin-top:8px">Descripci√≥n</label>
              <textarea id="description" placeholder="Descripci√≥n, detalles, medidas..."></textarea>
            </div>

            <div>
              <label>Imagen</label>
              <div class="img-preview"><img id="previewImg" alt="Preview"></div>
              <input id="imageFile" type="file" accept="image/*" style="margin-top:8px">

              <p class="muted" style="margin:8px 0 4px">La imagen se comprimir√° autom√°ticamente (m√°x 1000√ó1000). Si supera 2MB se mostrar√° una alerta.</p>

              <div style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap">
                <button class="btn primary" id="saveBtn" type="button">Guardar producto</button>
                <button type="button" class="btn ghost" id="newBtn">Limpiar</button>
                <button type="button" class="btn danger" id="deleteBtn">Eliminar actual</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <h4 style="margin:18px 0 8px">Lista de productos (modo edici√≥n)</h4>
      <div id="editorList" class="grid"></div>
    </section>

    <!-- CATALOGO -->
    <section id="catalogView" class="view" style="display:none">
      <div class="toolbar">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <input id="searchInput" type="search" placeholder="Buscar por nombre, c√≥digo o descripci√≥n" style="padding:10px; border-radius:10px; border:1px solid #e6eef5">
          <select id="filterCat" style="padding:10px; border-radius:10px; border:1px solid #e6eef5"></select>
          <button class="btn ghost" id="printBtn">Imprimir</button>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn ghost" id="expandAll">Expandir todo</button>
          <button class="btn ghost" id="collapseAll">Colapsar todo</button>
        </div>
      </div>

      <div id="catalogContainer"></div>
    </section>

    <!-- CATEGORIAS -->
    <section id="categoriesView" class="view" style="display:none">
      <div class="card">
        <h3 style="margin-top:0">Gesti√≥n de categor√≠as</h3>
        <div class="form-row" style="align-items:end">
          <div style="flex:1">
            <label>Nueva categor√≠a</label>
            <input id="newCategory" type="text" placeholder="Ej: Bebidas">
          </div>
          <div style="flex:1">
            <label>Nueva subcategor√≠a</label>
            <input id="newSubcategory" type="text" placeholder="Ej: Energ√©ticas">
          </div>
          <div>
            <button id="addCategoryBtn" class="btn primary">Agregar</button>
          </div>
        </div>
      </div>

      <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap">
        <div style="flex:1">
          <h4>Categor√≠as</h4>
          <div id="categoryList" class="list"></div>
        </div>
        <div style="flex:1">
          <h4>Subcategor√≠as</h4>
          <div id="subList" class="list"></div>
        </div>
      </div>
    </section>

    <!-- RESPALDO -->
    <section id="backupView" class="view" style="display:none">
      <div class="card">
        <h3 style="margin-top:0">Importar / Exportar</h3>
        <div class="form-row">
          <div style="flex:1">
            <label>Exportar (copia este JSON como respaldo)</label>
            <textarea id="exportArea" class="code" readonly></textarea>
          </div>
          <div style="flex:1">
            <label>Importar (pega aqu√≠ el JSON y presiona Importar)</label>
            <textarea id="importArea" class="code" placeholder='{"productos":[], "categorias":{}}'></textarea>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="exportBtn" class="btn primary">Generar respaldo</button>
          <button id="importBtn" class="btn warn">Importar</button>
          <button id="resetBtn" class="btn danger">Borrar todo</button>
        </div>
      </div>

      <!-- Instrucciones para hacer accesible -->
      <div class="card" style="margin-top:16px; background:#f0f9ff; border:1px solid #38bdf8">
        <h3 style="margin-top:0; color:#0369a1">üåê Hacer accesible desde cualquier ordenador</h3>
        <div style="color:#0c4a6e; line-height:1.6">
          <p><strong>Opciones recomendadas (GRATUITAS):</strong></p>
          <ol>
            <li><strong>GitHub Pages:</strong> Sube este archivo HTML a GitHub ‚Üí Settings ‚Üí Pages</li>
            <li><strong>Netlify:</strong> Ve a <code>netlify.com</code> ‚Üí Arrastra el archivo ‚Üí Obt√©n URL</li>
            <li><strong>Vercel:</strong> Similar a Netlify, muy f√°cil de usar</li>
          </ol>
          <p><strong>Para red local:</strong> Comparte la URL que aparece arriba en el header</p>
          <p style="margin-top:12px; padding:8px; background:rgba(59,130,246,0.1); border-radius:6px">
            üí° <strong>Tip:</strong> Una vez subido a cualquier hosting, podr√°s acceder desde cualquier dispositivo con internet
          </p>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

<script>
/* ----------------------------
   Utilidades y configuraci√≥n
   ---------------------------- */
const OLD_KEYS = {
  productos: 'productos',
  categorias: 'categorias',
  logo: 'libomi-logo'
};
const KEYS = {
  productos: 'libomi_products_v2',
  categorias: 'libomi_categories_v2',
  logo: 'libomi_logo_v2'
};

const PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(
  `<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="16" font-family="Arial">Sin imagen</text></svg>`
);

const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

// Lightbox variables
let currentZoom = 1;
let isDragging = false;
let startX, startY, currentX = 0, currentY = 0;

// Mostrar URL actual en el header
function updateUrlDisplay() {
  const urlElement = $('#currentUrl');
  if (urlElement) {
    urlElement.textContent = window.location.href;
  }
}

function showToast(msg, type='ok', ms=2000){
  const t = $('#toast');
  t.textContent = msg;
  t.className = 'toast ' + (type==='ok'?'ok': type==='warn'?'warn':'err');
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), ms);
}

/* ----------------------------
   Enhanced Lightbox functionality
   ---------------------------- */
function initLightbox() {
  const lightbox = $('#lightbox');
  const lightboxImage = $('#lightboxImage');
  const lightboxClose = $('#lightboxClose');
  const lightboxTitle = $('#lightboxTitle');
  const lightboxDescription = $('#lightboxDescription');
  const zoomIn = $('#zoomIn');
  const zoomOut = $('#zoomOut');
  const zoomReset = $('#zoomReset');

  // Open lightbox
  function openLightbox(imageSrc, title, description) {
    lightboxImage.src = imageSrc;
    lightboxTitle.textContent = title;
    lightboxDescription.textContent = description;
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
    resetImagePosition();
    
    // Show info after delay
    setTimeout(() => lightbox.classList.add('show-info'), 500);
  }

  // Close lightbox
  function closeLightbox() {
    lightbox.classList.remove('active', 'show-info');
    document.body.style.overflow = '';
    resetImagePosition();
  }

  // Reset image position and zoom
  function resetImagePosition() {
    currentZoom = 1;
    currentX = 0;
    currentY = 0;
    updateImageTransform();
  }

  // Update image transform
  function updateImageTransform() {
    lightboxImage.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentZoom})`;
  }

  // Zoom controls
  zoomIn.addEventListener('click', (e) => {
    e.stopPropagation();
    currentZoom = Math.min(currentZoom * 1.5, 4);
    updateImageTransform();
  });

  zoomOut.addEventListener('click', (e) => {
    e.stopPropagation();
    currentZoom = Math.max(currentZoom / 1.5, 0.5);
    updateImageTransform();
  });

  zoomReset.addEventListener('click', (e) => {
    e.stopPropagation();
    resetImagePosition();
  });

  // Mouse drag functionality
  lightboxImage.addEventListener('mousedown', (e) => {
    if (currentZoom <= 1) return;
    isDragging = true;
    startX = e.clientX - currentX;
    startY = e.clientY - currentY;
    lightboxImage.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    currentX = e.clientX - startX;
    currentY = e.clientY - startY;
    updateImageTransform();
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    lightboxImage.style.cursor = currentZoom > 1 ? 'grab' : 'zoom-out';
  });

  // Touch support for mobile
  let lastTouchDistance = 0;
  lightboxImage.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
      lastTouchDistance = Math.sqrt(
        Math.pow(e.touches[0].clientX - e.touches[1].clientX, 2) +
        Math.pow(e.touches[0].clientY - e.touches[1].clientY, 2)
      );
    }
  });

  lightboxImage.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const currentDistance = Math.sqrt(
        Math.pow(e.touches[0].clientX - e.touches[1].clientX, 2) +
        Math.pow(e.touches[0].clientY - e.touches[1].clientY, 2)
      );
      if (lastTouchDistance > 0) {
        const scale = currentDistance / lastTouchDistance;
        currentZoom = Math.min(Math.max(currentZoom * scale, 0.5), 4);
        updateImageTransform();
      }
      lastTouchDistance = currentDistance;
    }
  });

  // Close events
  lightboxClose.addEventListener('click', closeLightbox);
  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
  });

  // Mouse wheel zoom
  lightbox.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    currentZoom = Math.min(Math.max(currentZoom * delta, 0.5), 4);
    updateImageTransform();
  });

  // Export function to be used globally
  window.openLightbox = openLightbox;
}

/* ----------------------------
   Recuperar datos de localStorage (compatibilidad con versiones antiguas)
   ---------------------------- */
function retrieveStoredData(){
  // Prioridad: new keys -> old keys. Merge gracefully.
  let productos = null, categorias = null, logo = null;

  try {
    productos = JSON.parse(localStorage.getItem(KEYS.productos));
  } catch(e){ productos = null; }
  try {
    categorias = JSON.parse(localStorage.getItem(KEYS.categorias));
  } catch(e){ categorias = null; }
  if(!productos){
    try { productos = JSON.parse(localStorage.getItem(OLD_KEYS.productos)); } catch(e){ productos = null; }
  }
  if(!categorias){
    try { categorias = JSON.parse(localStorage.getItem(OLD_KEYS.categorias)); } catch(e){ categorias = null; }
  }
  // if still null, default
  if(!productos || !Array.isArray(productos)) productos = [];
  if(!categorias || typeof categorias !== 'object') categorias = {
    "General": ["Varios"]
  };
  // logo: try new, else old
  logo = localStorage.getItem(KEYS.logo) || localStorage.getItem(OLD_KEYS.logo) || null;

  return { productos, categorias, logo };
}

let state = retrieveStoredData();

/* ----------------------------
   Guardar estado
   ---------------------------- */
function persistState(){
  try {
    localStorage.setItem(KEYS.productos, JSON.stringify(state.productos));
    localStorage.setItem(KEYS.categorias, JSON.stringify(state.categorias));
  } catch(e){
    console.error('Error guardando en localStorage', e);
    showToast('No se pudo guardar localmente', 'err');
  }
}

/* ----------------------------
   Elementos DOM
   ---------------------------- */
const tabs = $$('.tab');
const views = {
  editor: $('#editorView'),
  catalogo: $('#catalogView'),
  categorias: $('#categoriesView'),
  respaldo: $('#backupView')
};
const logoImg = $('#logo');
const logoFile = $('#logoFile');
const changeLogoBtn = $('#changeLogoBtn');
const clearLogoBtn = $('#clearLogoBtn');

const inputId = $('#productId');
const inputName = $('#name');
const inputCode = $('#code');
const inputCategory = $('#category');
const inputSubcategory = $('#subcategory');
const inputDescription = $('#description');
const imageFile = $('#imageFile');
const previewImg = $('#previewImg');
const saveBtn = $('#saveBtn');
const newBtn = $('#newBtn');
const deleteBtn = $('#deleteBtn');
const editorList = $('#editorList');

const searchInput = $('#searchInput');
const filterCat = $('#filterCat');
const catalogContainer = $('#catalogContainer');
const printBtn = $('#printBtn');
const expandAll = $('#expandAll');
const collapseAll = $('#collapseAll');

const newCategoryInput = $('#newCategory');
const newSubcategoryInput = $('#newSubcategory');
const addCategoryBtn = $('#addCategoryBtn');
const categoryList = $('#categoryList');
const subList = $('#subList');

const exportArea = $('#exportArea');
const importArea = $('#importArea');
const exportBtn = $('#exportBtn');
const importBtn = $('#importBtn');
const resetBtn = $('#resetBtn');

/* ----------------------------
   Inicializaci√≥n UI
   ---------------------------- */
function initUI(){
  // Initialize lightbox
  initLightbox();
  
  // Actualizar URL display
  updateUrlDisplay();
  
  // logo
  if(state.logo) logoImg.src = state.logo; else logoImg.src = PLACEHOLDER;

  // tabs
  tabs.forEach(t => t.addEventListener('click', ()=> {
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const target = t.dataset.tab;
    // hide all
    Object.values(views).forEach(v=> v.style.display = 'none');
    // show target
    if(target === 'editor') views.editor.style.display = 'block';
    if(target === 'catalogo') { views.catalogo.style.display = 'block'; renderCatalog(true); }
    if(target === 'categorias') views.categorias.style.display = 'block';
    if(target === 'respaldo') views.respaldo.style.display = 'block';
  }));

  // file logo
  changeLogoBtn.addEventListener('click', ()=> logoFile.click());
  logoFile.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return showToast('Selecciona una imagen', 'warn');
    try {
      const data = await compressImage(f, 600, 600, 0.85);
      logoImg.src = data;
      state.logo = data;
      localStorage.setItem(KEYS.logo, data);
      showToast('Logo guardado');
    } catch(err){
      console.error(err);
      showToast('No se pudo procesar logo','err');
    }
  });
  clearLogoBtn.addEventListener('click', ()=>{
    state.logo = null;
    localStorage.removeItem(KEYS.logo);
    logoImg.src = PLACEHOLDER;
    showToast('Logo eliminado','warn');
  });

  // preview placeholder
  previewImg.src = PLACEHOLDER;

  // populate categories select
  refreshCategorySelects();
}

/* ----------------------------
   Category helpers
   ---------------------------- */
function refreshCategorySelects(){
  const cats = Object.keys(state.categorias);
  inputCategory.innerHTML = '';
  filterCat.innerHTML = '<option value="">Todas las categor√≠as</option>';
  // default top option for category select
  for(const c of cats){
    const o = document.createElement('option'); o.value = c; o.textContent = c; inputCategory.appendChild(o);
    const o2 = document.createElement('option'); o2.value = c; o2.textContent = c; filterCat.appendChild(o2);
  }
  // subcategories for first category
  const selCat = inputCategory.value || cats[0];
  populateSubcategories(selCat);
}

function populateSubcategories(cat){
  const subs = (state.categorias[cat]||[]);
  inputSubcategory.innerHTML = '<option value="">(ninguna)</option>';
  for(const s of subs){ const o = document.createElement('option'); o.value = s; o.textContent = s; inputSubcategory.appendChild(o); }
  // also fill subList
  renderCategoryLists();
}

/* ----------------------------
   Compress image util
   ---------------------------- */
function compressImage(file, maxW=1000, maxH=1000, quality=0.75){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onerror = ()=> reject(new Error('Error leyendo archivo'));
    fr.onload = () => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height;
        const ratio = Math.min(1, maxW/w, maxH/h);
        const cw = Math.round(w * ratio), ch = Math.round(h * ratio);
        const canvas = document.createElement('canvas');
        canvas.width = cw; canvas.height = ch;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, cw, ch);
        canvas.toBlob(blob => {
          if(!blob) return reject(new Error('No se gener√≥ imagen'));
          const fr2 = new FileReader();
          fr2.onerror = ()=> reject(new Error('Error leyendo blob'));
          fr2.onload = ()=> resolve(fr2.result);
          fr2.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      };
      img.onerror = ()=> reject(new Error('Error cargando imagen'));
      img.src = fr.result;
    };
    fr.readAsDataURL(file);
  });
}

/* ----------------------------
   Image input preview
   ---------------------------- */
imageFile.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  if(f.size > 2 * 1024 * 1024) showToast('Imagen > 2MB: se comprimir√° al guardar', 'warn', 3000);
  const fr = new FileReader();
  fr.onload = () => previewImg.src = fr.result;
  fr.readAsDataURL(f);
});

/* ----------------------------
   Save / New / Delete product
   ---------------------------- */
saveBtn.addEventListener('click', async (ev) => {
  ev.preventDefault();
  const btnText = saveBtn.textContent;
  saveBtn.disabled = true; saveBtn.textContent = 'Guardando...';

  const id = inputId.value || String(Date.now());
  const name = inputName.value.trim();
  const code = inputCode.value.trim();
  const category = inputCategory.value;
  const subcategory = inputSubcategory.value || '';
  const description = inputDescription.value.trim();

  if(!name || !category){
    showToast('Completa Nombre y Categor√≠a', 'err');
    saveBtn.disabled = false; saveBtn.textContent = btnText;
    return;
  }

  // process image if user selected file
  let imageData = null;
  const f = imageFile.files && imageFile.files[0];
  try {
    if(f){
      imageData = await compressImage(f, 1000, 1000, 0.75);
    }
  } catch(err){
    console.error('Error al comprimir', err);
    showToast('Error al procesar imagen', 'err');
  }

  const finalImage = imageData || previewImg.src || PLACEHOLDER;

  const product = { id, nombre: name, codigo: code, descripcion: description, categoria: category, subcategoria: subcategory, imagen: finalImage };

  // replace or push
  const idx = state.productos.findIndex(p=>p.id === id);
  if(idx >= 0) state.productos[idx] = product; else state.productos.push(product);

  persistState();
  renderEditorList();
  renderCatalog();
  showToast('Producto guardado','ok');
  inputId.value = id;
  saveBtn.disabled = false; saveBtn.textContent = btnText;
});

// New / clear form
newBtn.addEventListener('click', ()=>{
  inputId.value = '';
  inputName.value = ''; inputCode.value = ''; inputDescription.value = '';
  imageFile.value = ''; previewImg.src = PLACEHOLDER;
  refreshCategorySelects();
  showToast('Formulario limpio','ok');
});

// delete current
deleteBtn.addEventListener('click', ()=>{
  const id = inputId.value;
  if(!id){ showToast('No hay producto cargado','warn'); return; }
  if(!confirm('¬øEliminar el producto actual?')) return;
  state.productos = state.productos.filter(p=>p.id !== id);
  persistState();
  renderEditorList(); renderCatalog();
  // clear form
  newBtn.click();
  showToast('Producto eliminado','warn');
});

/* ----------------------------
   Render editor list
   ---------------------------- */
function productHtml(p, mode='editor'){
  let actions = '';
  if(mode === 'editor'){
    actions = `
      <div class="product-actions">
        <button class="btn ghost" data-edit="${p.id}">Editar</button>
        <button class="btn danger" data-delete="${p.id}">Eliminar</button>
      </div>`;
  }
  
  // Enhanced thumbnail with lightbox functionality
  const thumbHtml = `
    <div class="thumb" data-lightbox='{"src":"${p.imagen || PLACEHOLDER}", "title":"${escapeHtml(p.nombre)}", "description":"${escapeHtml(p.descripcion || '')}"}'>
      <img src="${p.imagen || PLACEHOLDER}" alt="${escapeHtml(p.nombre)}">
    </div>
  `;
  
  return `
    <div class="product-card" data-id="${p.id}">
      <div class="product-top">
        ${thumbHtml}
        <div class="product-info">
          <h4>${escapeHtml(p.nombre)}</h4>
          <div class="muted">${p.codigo? 'C√≥digo: ' + escapeHtml(p.codigo): ''}</div>
          <div class="muted">${escapeHtml(p.categoria || '')}${p.subcategoria? ' / ' + escapeHtml(p.subcategoria): ''}</div>
          <div style="margin-top:8px; color:#334155; font-size:14px; white-space:pre-wrap">${escapeHtml(p.descripcion || '')}</div>
        </div>
      </div>
      ${actions}
    </div>
  `;
}

function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

function renderEditorList(){
  editorList.innerHTML = state.productos.map(p => productHtml(p,'editor')).join('') || '<div class="muted">No hay productos</div>';
  
  // Bind lightbox events to thumbnails
  bindLightboxEvents(editorList);
  
  // bind edit/delete
  editorList.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-edit');
      const p = state.productos.find(x=>x.id===id);
      if(!p) return;
      inputId.value = p.id;
      inputName.value = p.nombre || '';
      inputCode.value = p.codigo || '';
      inputDescription.value = p.descripcion || '';
      previewImg.src = p.imagen || PLACEHOLDER;
      imageFile.value = '';
      inputCategory.value = p.categoria || '';
      populateSubcategories(inputCategory.value);
      inputSubcategory.value = p.subcategoria || '';
      showToast('Producto cargado para editar','ok');
      window.scrollTo({top:0, behavior:'smooth'});
    });
  });
  editorList.querySelectorAll('[data-delete]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-delete');
      if(!confirm('¬øEliminar este producto?')) return;
      state.productos = state.productos.filter(p=>p.id !== id);
      persistState();
      renderEditorList(); renderCatalog();
      showToast('Producto eliminado','warn');
    });
  });
}

/* ----------------------------
   Bind lightbox events
   ---------------------------- */
function bindLightboxEvents(container) {
  container.querySelectorAll('[data-lightbox]').forEach(thumb => {
    thumb.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      try {
        const data = JSON.parse(thumb.getAttribute('data-lightbox'));
        window.openLightbox(data.src, data.title, data.description);
      } catch(err) {
        console.error('Error opening lightbox:', err);
      }
    });
  });
}

/* ----------------------------
   Render catalog grouped by category/subcategory
   ---------------------------- */
function groupProducts(){
  const map = {};
  for(const p of state.productos){
    const c = p.categoria || 'General';
    const s = p.subcategoria || 'Varios';
    if(!map[c]) map[c] = {};
    if(!map[c][s]) map[c][s] = [];
    map[c][s].push(p);
  }
  return map;
}

function renderCatalog(fromTab=false){
  // ensure categories select updated
  refreshCategorySelects();
  const q = (searchInput.value || '').trim().toLowerCase();
  const catFilter = filterCat.value || '';
  const groups = groupProducts();
  let html = '';
  for(const cat of Object.keys(groups)){
    if(catFilter && cat !== catFilter) continue;
    html += `<div style="margin-bottom:18px"><h3 style="margin:6px 0">${escapeHtml(cat)}</h3>`;
    for(const sub of Object.keys(groups[cat])){
      const list = groups[cat][sub].filter(p=>{
        if(!q) return true;
        const hay = (p.nombre + ' ' + (p.codigo||'') + ' ' + (p.descripcion||'')).toLowerCase();
        return hay.includes(q);
      });
      if(list.length === 0) continue;
      html += `<div style="margin-bottom:8px"><h4 style="margin:4px 0; font-size:16px">${escapeHtml(sub)}</h4><div class="grid">`;
      for(const p of list) html += productHtml(p,'catalog');
      html += `</div></div>`;
    }
    html += `</div>`;
  }
  catalogContainer.innerHTML = html || '<div class="muted">No hay productos para mostrar</div>';
  
  // Bind lightbox events to catalog
  bindLightboxEvents(catalogContainer);
  
  if(fromTab) window.scrollTo({top:0, behavior:'smooth'});
}

/* ----------------------------
   Expand / collapse helpers
   ---------------------------- */
expandAll.addEventListener('click', ()=> {
  // no collapsing implemented as sections are always shown ‚Äî placeholder for UX
  showToast('Expandir: no aplica (vista ya expandida)','ok');
});
collapseAll.addEventListener('click', ()=> showToast('Colapsar: no aplica','ok'));

/* ----------------------------
   Categories manager
   ---------------------------- */
function renderCategoryLists(){
  const cats = Object.keys(state.categorias || {});
  categoryList.innerHTML = cats.map(c => `
    <div class="list-item">
      <div><strong>${escapeHtml(c)}</strong></div>
      <div style="display:flex;gap:6px">
        <button class="btn ghost" data-select-cat="${escapeHtml(c)}">Seleccionar</button>
        <button class="btn danger" data-remove-cat="${escapeHtml(c)}">Eliminar</button>
      </div>
    </div>
  `).join('') || '<div class="muted" style="padding:8px">Sin categor√≠as</div>';

  // show subcategories for first or selected category
  const sel = cats[0];
  const subs = (sel && state.categorias[sel]) ? state.categorias[sel] : [];
  subList.innerHTML = subs.map(s => `
    <div class="list-item">
      <div>${escapeHtml(s)}</div>
      <div><button class="btn danger" data-remove-sub="${escapeHtml(s)}">Quitar</button></div>
    </div>
  `).join('') || '<div class="muted" style="padding:8px">Sin subcategor√≠as</div>';

  // Bind events
  categoryList.querySelectorAll('[data-select-cat]').forEach(b => {
    b.addEventListener('click', ()=>{
      const c = b.getAttribute('data-select-cat');
      inputCategory.value = c;
      populateSubcategories(c);
      renderCategoryLists();
    });
  });
  categoryList.querySelectorAll('[data-remove-cat]').forEach(b => {
    b.addEventListener('click', ()=>{
      const c = b.getAttribute('data-remove-cat');
      if(!confirm(`¬øEliminar categor√≠a "${c}"? Los productos permanecer√°n sin categor√≠a.`)) return;
      // remove category, set products to empty category
      delete state.categorias[c];
      state.productos = state.productos.map(p => p.categoria === c ? ({...p, categoria:'', subcategoria:''}) : p);
      persistState();
      refreshCategorySelects();
      renderEditorList();
      renderCatalog();
      renderCategoryLists();
      showToast('Categor√≠a eliminada','warn');
    });
  });
  subList.querySelectorAll('[data-remove-sub]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const s = b.getAttribute('data-remove-sub');
      // find which category contains this sub
      const cat = Object.keys(state.categorias).find(c => state.categorias[c].includes(s));
      if(!cat) return;
      if(!confirm(`¬øEliminar subcategor√≠a "${s}" de "${cat}"? Los productos perder√°n la subcategor√≠a.`)) return;
      state.categorias[cat] = state.categorias[cat].filter(x => x !== s);
      state.productos = state.productos.map(p => (p.categoria===cat && p.subcategoria===s) ? ({...p, subcategoria:''}) : p);
      persistState(); refreshCategorySelects(); renderEditorList(); renderCatalog(); renderCategoryLists();
      showToast('Subcategor√≠a eliminada','warn');
    });
  });
}

addCategoryBtn.addEventListener('click', ()=>{
  const cat = (newCategoryInput.value || '').trim();
  const sub = (newSubcategoryInput.value || '').trim();
  if(!cat){ showToast('Escribe el nombre de la categor√≠a','warn'); return; }
  if(!state.categorias[cat]) state.categorias[cat] = [];
  if(sub && !state.categorias[cat].includes(sub)) state.categorias[cat].push(sub);
  persistState(); refreshCategorySelects(); renderCategoryLists();
  newCategoryInput.value = ''; newSubcategoryInput.value = '';
  showToast('Categor√≠a guardada','ok');
});

/* ----------------------------
   Import / Export
   ---------------------------- */
exportBtn.addEventListener('click', ()=>{
  const dump = {
    productos: state.productos,
    categorias: state.categorias,
    logo: state.logo || null
  };
  exportArea.value = JSON.stringify(dump, null, 2);
  showToast('Respaldo generado');
});

importBtn.addEventListener('click', ()=>{
  const text = importArea.value;
  if(!text) { showToast('Pega un JSON para importar','warn'); return; }
  let data;
  try { data = JSON.parse(text); } catch(e){ showToast('JSON inv√°lido','err'); return; }
  if(Array.isArray(data.productos)) state.productos = data.productos;
  if(data.categorias && typeof data.categorias === 'object') state.categorias = data.categorias;
  if(data.logo) { state.logo = data.logo; localStorage.setItem(KEYS.logo, data.logo); logoImg.src = data.logo; }
  persistState();
  refreshCategorySelects(); renderEditorList(); renderCatalog(); renderCategoryLists();
  showToast('Importaci√≥n completada','ok');
});

resetBtn.addEventListener('click', ()=>{
  if(!confirm('¬øBorrar TODO (productos, categor√≠as, logo)? Esta acci√≥n no se puede deshacer.')) return;
  state.productos = [];
  state.categorias = { "General": ["Varios"] };
  state.logo = null;
  localStorage.removeItem(KEYS.productos);
  localStorage.removeItem(KEYS.categorias);
  localStorage.removeItem(KEYS.logo);
  logoImg.src = PLACEHOLDER;
  refreshCategorySelects(); renderEditorList(); renderCatalog(); renderCategoryLists();
  showToast('Todo borrado','warn');
});

/* ----------------------------
   Printing
   ---------------------------- */
printBtn.addEventListener('click', ()=> {
  window.print();
});

/* ----------------------------
   Init render
   ---------------------------- */
function boot(){
  // Initialize UI
  initUI();
  // Merge fallback from older keys once at boot: if new keys empty but old keys exist, migrate
  // (retrieveStoredData already attempted merging)
  refreshCategorySelects();
  renderEditorList();
  renderCatalog();
  renderCategoryLists();
}

/* ----------------------------
   Utility: listen changes of select category to update subcategories
   ---------------------------- */
inputCategory.addEventListener('change', ()=>{
  populateSubcategories(inputCategory.value);
});

/* ----------------------------
   Search & filter events
   ---------------------------- */
searchInput.addEventListener('input', ()=> renderCatalog());
filterCat.addEventListener('change', ()=> renderCatalog());

/* ----------------------------
   On load: if there are old keys, offer to import automatically (non-intrusive)
   ---------------------------- */
(function tryAutoMigrate(){
  // If there is data under old keys and new keys are empty, copy them
  const oldProducts = localStorage.getItem(OLD_KEYS.productos);
  const oldCats = localStorage.getItem(OLD_KEYS.categorias);
  if((oldProducts || oldCats) && (!localStorage.getItem(KEYS.productos) && !localStorage.getItem(KEYS.categorias)) ){
    try {
      if(oldProducts) localStorage.setItem(KEYS.productos, oldProducts);
      if(oldCats) localStorage.setItem(KEYS.categorias, oldCats);
      // update state
      state = retrieveStoredData();
      persistState();
      refreshCategorySelects();
      renderEditorList(); renderCatalog(); renderCategoryLists();
      console.info('Datos antiguos migrados autom√°ticamente');
    } catch(e){
      console.warn('No se pudo migrar autom√°ticamente', e);
    }
  }
})();

// Initialize everything when page loads
boot();

</script>
</body>
</html>